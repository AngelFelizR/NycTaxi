---
title: "Expaling Top Models"
editor_options: 
  chunk_output_type: console
execute:
  message: false
  warning: false
---

Now is time to understand what is going under the h
    
## Setting up the environment

Here are the loaded libraries to start the process.

```{r}
## To manage relative paths
library(here)

## To transform data that fits in RAM
library(data.table)
library(lubridate)
library(timeDate)
library(ggtext)

## Tools for modeling
library(tidymodels)
library(embed)
library(themis)
library(discrim)
library(baguette)

## Publish data sets, models, and other R objects
library(pins)

## Custom functions
devtools::load_all()

# Defining the pin boards to use
BoardLocal <- board_folder(here("../NycTaxiPins/Board"))

# Loading params
Params <- yaml::read_yaml(here("params.yml"))
Params$BoroughColors <- unlist(Params$BoroughColors)
```

## Importing data

Here we import the data to use from the remote Board located in a github repo.

```{r}
AcsVariablesByZoneId <-
  pin_read(BoardLocal, "AcsVariablesByZoneId")[,
    LocationID := as.character(LocationID)
  ]

OmsDensityFeatures <- pin_read(BoardLocal, "OmsDensityFeatures")[,
  LocationID := as.character(LocationID)
]

ZoneCodesRef <- pin_read(BoardLocal, "ZoneCodesRef")[, c(
  "LocationID",
  "Borough",
  "service_zone"
)]

SampledData <-
  pin_list(BoardLocal) |>
  grep(pattern = "^OneMonthData", value = TRUE) |>
  sort() |>
  head(12L) |>
  lapply(FUN = pin_read, board = BoardLocal) |>
  rbindlist() |>
  tibble::as_tibble() |>
  mutate(
    take_current_trip = fifelse(take_current_trip == 1L, "yes", "no") |>
      factor(levels = c("yes", "no")),
    PULocationID = as.character(PULocationID),
    DOLocationID = as.character(DOLocationID)
  )

set.seed(2545)
TrainingSample <-
  initial_split(SampledData, strata = take_current_trip) |>
  training()

InitialFinalizedLogisticWf <- pin_read(BoardLocal, "InitialFinalizedLogisticWf")
LogisticPreprocessor <- extract_preprocessor(InitialFinalizedLogisticWf)
LogisticSpec <- extract_spec_parsnip(InitialFinalizedLogisticWf)
```

## Importing workflows to train

```{r}
#| eval: false

TrainingSampleProcessed <-
  prep(LogisticPreprocessor) |>
  bake(new_data = TrainingSample)

pin_write(
  BoardLocal,
  TrainingSampleProcessed,
  "TrainingSampleProcessed",
  type = "qs2"
)
```

## Fitting resamples

```{r}
#| eval: false

set.seed(5878)
TrainingSampleProcessedResamples <- vfold_cv(
  TrainingSampleProcessed,
  v = 5,
  strata = take_current_trip
)

InitialFinalizedLogisticFitted <-
  recipe(take_current_trip ~ ., data = TrainingSampleProcessed) |>
  update_role(
    trip_id,
    performance_per_hour,
    percentile_75_performance,
    new_role = "additional info"
  ) |>
  workflow(
    LogisticSpec
  ) |>
  fit_resamples(
    resamples = TrainingSampleProcessedResamples,
    metrics = metric_set(brier_class),
    control = control_resamples(save_pred = TRUE, extract = identity)
  )

set.seed(5878)
TrainingSampleResamples <- vfold_cv(
  TrainingSample,
  v = 5,
  strata = take_current_trip
)

InitialFinalizedLogisticFitted2 <-
  fit_resamples(
    InitialFinalizedLogisticWf,
    resamples = TrainingSampleResamples,
    metrics = metric_set(brier_class),
    control = control_resamples(save_pred = TRUE, extract = identity)
  )

pin_write(
  BoardLocal,
  InitialFinalizedLogisticFitted,
  "InitialFinalizedLogisticFitted",
  type = "qs2"
)

pin_write(
  BoardLocal,
  InitialFinalizedLogisticFitted2,
  "InitialFinalizedLogisticFitted2",
  type = "qs2"
)
```

```{r}
InitialFinalizedLogisticFitted <- pin_read(
  BoardLocal,
  "InitialFinalizedLogisticFitted",
)

InitialFinalizedLogisticFitted2 <- pin_read(
  BoardLocal,
  "InitialFinalizedLogisticFitted2",
)

TrainingSampleProcessed <- pin_read(
  BoardLocal,
  "TrainingSampleProcessed"
)

InitialFinalizedLogisticPredictions <- collect_predictions(
  InitialFinalizedLogisticFitted
)
```

```{r}
ggplot(InitialFinalizedLogisticPredictions) +
  geom_histogram(
    aes(.pred_yes, fill = take_current_trip),
    alpha = 0.3,
    position = position_identity()
  ) +
  theme_light()
```


```{r}
InitialFinalizedLogisticPredictions |>
  mutate(
    yes_pred = (take_current_trip == "yes") * 1,
    residual = yes_pred - .pred_yes
  ) |>
  summarize(total_residual = sum(abs(residual)))
```

```{r}
library(DALEX)
fitted_resamples = InitialFinalizedLogisticFitted
fold_id = "Fold1"
create_fold_explainer <- function(fitted_resamples, fold_id) {
  order_id = sub("Fold", "", fold_id) |> as.integer()
  fitted_workflow = fitted_resamples$.extracts[[order_id]]$`.extracts`[[1L]]
  testing_data = testing(fitted_resamples$splits[[order_id]])

  DALEXtra::explain_tidymodels(
    fitted_workflow,
    data = testing_data,
    y = as.double(testing_data[["take_current_trip"]] == "yes")
  )
}

CreatedFold <- InitialFinalizedLogisticFitted$id
names(CreatedFold) <- CreatedFold

ExplainerList <- lapply(
  CreatedFold,
  FUN = create_fold_explainer,
  fitted_resamples = InitialFinalizedLogisticFitted
)

set.seed(1801)
biggest_error <-
  predict_parts(
    explainer = ExplainerList[["Fold1"]],
    new_observation = TrainingSample[40800, ]
  )
```

```{r}
library(forcats)
biggest_error %>%
  group_by(variable) %>%
  mutate(mean_val = mean(contribution)) %>%
  ungroup() %>%
  mutate(variable = fct_reorder(variable, abs(mean_val))) %>%
  ggplot(aes(contribution, variable, fill = mean_val > 0)) +
  geom_col(
    data = ~ distinct(., variable, mean_val),
    aes(mean_val, variable),
    alpha = 0.5
  ) +
  geom_boxplot(width = 0.5) +
  theme(legend.position = "none") +
  scale_fill_viridis_d() +
  labs(y = NULL)
```

