---
title: "Defining Development Environment"
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

To reproduce the results of this project, follow these steps to set up the same environment using Docker and Nix.

### 1. Install Docker and Docker Compose

You need **Docker** and **Docker Compose**. Choose the appropriate installation method for your operating system:

* **Windows or macOS**: Install [Docker Desktop](https://www.docker.com/products/docker-desktop/) (includes Docker Compose).
* **Linux**: Install the [Docker Engine](https://docs.docker.com/engine/install/) and then [Docker Compose](https://docs.docker.com/compose/install/).

For **Debian 13** (as an example), run the following as root:

```bash
apt update
apt install -y apt-transport-https ca-certificates curl gnupg2 software-properties-common
curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add -
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian trixie stable"
apt update
apt install -y docker-ce docker-compose-plugin
systemctl enable docker && systemctl start docker
usermod -aG docker <YOUR-USER>
su - <YOUR-USER>
```

**Note:** Replace `<YOUR-USER>` with your actual username.

### 2. Pull the Pre‑built Docker Image

The project environment is available on Docker Hub. Pull the image with:

```bash
docker pull angelfelizr/nyc-taxi:4.5.2
```

(If you prefer to build the image locally, you can run `docker compose build` instead, but pulling is faster and guarantees the same environment.)

### 3. Clone the Repository and Prepare Directories

Navigate to the parent directory where you want to store the project and the data folders. Then run:

```bash
cd <parent-dir-path>
mkdir NycTaxiBigFiles
mkdir NycTaxiPins
git clone https://github.com/AngelFelizR/NycTaxi
```

Your directory structure should look like:

```
<parent-dir-path>/
├── NycTaxi/               # cloned repository
├── NycTaxiBigFiles/       # large data files (mounted into container)
└── NycTaxiPins/           # pin board storage (mounted into container)
```

### 4. Start the Container with Docker Compose

The repository contains a `docker-compose.yml` file that defines the service. From inside the `NycTaxi` folder, start the container in detached mode:

```bash
cd NycTaxi
docker compose up -d
```

This will:

- Use the image `angelfelizr/nyc-taxi:4.5.2` (or build it if you haven’t pulled it).
- Map port `2222` on your host to port `22` inside the container (for SSH).
- Mount the three directories you created (`NycTaxi`, `NycTaxiBigFiles`, `NycTaxiPins`) into the container under `/root/`.

You can verify the container is running with `docker compose ps`.

### 5. Access the Container

You have two options to connect to the container:

#### Option A: SSH with password (simplest)

The container is configured to allow root login with the password `sbs`. Connect using:

```bash
ssh root@localhost -p 2222
# password: sbs
```

#### Option B: SSH with a public key (optional)

If you prefer key‑based authentication, copy your public key into the container:

```bash
docker compose cp ~/.ssh/id_rsa.pub nyc-taxi:/root/.ssh/authorized_keys
docker compose exec nyc-taxi chown root:root /root/.ssh/authorized_keys
docker compose exec nyc-taxi chmod 600 /root/.ssh/authorized_keys
```

Then add the next text to `~/.ssh/config`

```bash
Host NycTaxi
    HostName 127.0.0.1
    User root
    Port 2222
    IdentityFile ~/.ssh/id_rsa
```

Then you can SSH without a password.

### 6. Using Positron (or VS Code) with direnv

As `direnv` is configured based on the `.envrc`, you can use Positron with the SSH remote development feature.

1. In Positron, select **“Connect to Host…”** (or use the Remote Explorer).
2. Enter `root@localhost:2222` and authenticate with the password `sbs` (or your SSH key).
3. Once connected, open the folder `/root/NycTaxi`.
4. Install the **direnv extension** by **mkhl** from the Open VSX Registry. This extension automatically activates direnv when you open a folder containing an `.envrc` file.

After the extension loads, you should see a notification that direnv is active. Now, any terminal you open inside Positron will have the Nix environment loaded, and the **R interactive console** will have access to all the R packages defined in `default.nix` after removing the one that comes as default.

### 7. Remote Pin Board (Optional)

If you need to use the shared pin board, create a cache directory on your host (outside the container) and then, inside R, set up the board as follows:

```bash
# On your host (in <parent-dir-path>)
mkdir NycTaxiBoardCache
```

In your R session (inside the Nix shell), use:

```r
BoardRemote <- board_url(
  "https://raw.githubusercontent.com/AngelFelizR/NycTaxiPins/refs/heads/main/Board/",
  cache = here::here("../NycTaxiBoardCache")
)
```

The cache directory is mounted into the container at `/root/NycTaxiBoardCache`, so pins will be stored on your host and persist between container restarts.
